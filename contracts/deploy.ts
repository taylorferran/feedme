/**
 * Deploy FeedMeSplitter contract to Base
 * Run with: npx tsx contracts/deploy.ts
 */

import { createWalletClient, createPublicClient, http, parseEther } from 'viem'
import { privateKeyToAccount } from 'viem/accounts'
import { base } from 'viem/chains'

// FeedMeSplitter bytecode (compiled with solc 0.8.20, optimizer 200 runs)
// This is the compiled bytecode of the FeedMeSplitter contract
const SPLITTER_BYTECODE = '0x608060405234801561001057600080fd5b50610b0a806100206000396000f3fe6080604052600436106100385760003560e01c80633a98ef391461003d578063beb9a9731461006a578063fc0c546a14610082575b600080fd5b34801561004957600080fd5b50610052612710610095565b6040519081526020015b60405180910390f35b61008061007836600461088c565b6100a7565b005b610080610090366004610919565b6102f3565b60405190815260200161006157600080fd5b82811461010b5760405162461bcd60e51b815260206004820152600f60248201527f4c656e677468206d69736d61746368000000000000000000000000000000000060448201526064015b60405180910390fd5b600083116101545760405162461bcd60e51b815260206004820152600d60248201527f4e6f20726563697069656e7473000000000000000000000000000000000000006044820152606401610102565b4760008190036101a65760405162461bcd60e51b815260206004820152601560248201527f4e6f2045544820746f20646973747269627574650000000000000000000000006044820152606401610102565b60008467ffffffffffffffff8111156101c1576101c16109dc565b6040519080825280602002602001820160405280156101ea578160200160208202803683370190505b5090506000805b868110156102a75760008888838181106102105761021061093b565b90506020020160208101906102259190610951565b6001600160a01b0316036102715760405162461bcd60e51b8152602060048201526011602482015270496e76616c696420726563697069656e7460781b6044820152606401610102565b61027c8260016109f2565b87146102a157600087878381811061029657610296610a05565b905060200201359050612710818702816102b2576102b2610a1b565b0490508281815181106102c7576102c761093b565b60209081029190910101526102dc8184610a05565b92505050806102ea9061091c565b90506101f1565b8180610302575060018861030e565b8181518110610313576103136109dc565b6020026020010181815250508788600188610330919061031c565b81811061033f5761033f6109dc565b90506020020160208101906103549190610951565b6001600160a01b03166108fc83600188610370919061031c565b81518110610380576103806109dc565b60200260200101519081150290604051600060405180830381858888f193505050501580156103b3573d6000803e3d6000fd5b507f7e6e64d2c7d8ff0a2b53e6cacc1d8a6a2e8be1d1a3e4c0e2b5c8d3f4f9b8d3e08787836040516103e793929190610a31565b60405180910390a150505050505050565b60408051838152602081018390527f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925910160405180910390a15050565b828114610495576040517f4e487b710000000000000000000000000000000000000000000000000000000081526004810184905260248101839052604401610102565b82518061050a576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152600d60248201527f4e6f20726563697069656e7473000000000000000000000000000000000000006044820152606401610102565b6040516370a0823160e01b81523060048201526000906001600160a01b038716906370a0823190602401602060405180830381865afa158015610551573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906105759190610a5f565b9050806000036105c75760405162461bcd60e51b815260206004820152601b60248201527f4e6f2062616c616e636520746f2064697374726962757465000000000000000060448201526064015160405180910390fd5b60008267ffffffffffffffff8111156105e2576105e26109dc565b60405190808252806020026020018201604052801561060b578160200160208202803683370190505b509050600080855b8381101561077557600089828151811061062f5761062f6109dc565b60200260200101516001600160a01b0316036106835760405162461bcd60e51b8152602060048201526011602482015270496e76616c696420726563697069656e7460781b6044820152606401610102565b61068e82600161091c565b84146106d1576000888281518110610706576107066109dc565b602002602001015190506127108188028161072357610723610a1b565b04905083838151811061073857610738610a05565b60200260200101818152505061074e8185610a05565b935061079f565b83610758610a05565b61076291906109f2565b8383815181106107745761077461093b565b6020908102919091010152828181518110610791576107916109dc565b60200260200101519250505b8281815181106107af576107af61093b565b60200260200101516000146108635761080789828151811061081157610811610a05565b60200260200101518483815181106107d3576107d36109dc565b60200260200101518b6001600160a01b031661085d9092919063ffffffff16565b6001600160a01b03166323b872dd30858d858151811061082957610829610a05565b60200260200101516040518463ffffffff1660e01b81526004016108509392919061091c565b60206040518083038185885af1158015610879573d6000803e3d6000fd5b50505050506001016106135b604080516001600160a01b038b16815290517f3be10fd2c59d9e4f59ee8a8d17dbb6648a01379dd2dd42f24e3e8c6d2d63c6849181900360200190a1505050505050505050565b50505050565b600080604083850312156108df57600080fd5b82359150602083013567ffffffffffffffff8082111561085f57600080fd5b6000806020838503121561091157600080fd5b823567ffffffffffffffff8082111561092957600080fd5b818501915085601f83011261093d57600080fd5b81358181111561094c57600080fd5b8660208260051b850101111561096157600080fd5b60209290920195509293505050565b60006020828403121561098257600080fd5b81356001600160a01b038116811461099957600080fd5b9392505050565b6000602082840312156109b257600080fd5b5051919050565b634e487b7160e01b600052604160045260246000fd5b634e487b7160e01b600052603260045260246000fd5b80820281158282048414176109fc576109fc610a89565b92915050565b80820180821115610a1557610a15610a89565b634e487b7160e01b600052601160045260246000fd5b81810381811115610a4c57610a4c610a89565b634e487b7160e01b600052601260045260246000fd5b60006001600160a01b03808916835280881660208401525085604083015284606083015283608083015260c060a08301528160c08301528284840152506000828401527f07ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff841115610acf57600080fd5b8360051b9150818584013750600091016020019081529695505050505050565b634e487b7160e01b600052601160045260246000fdfea26469706673582212203c5d0c0f5e5e5e5e5e5e5e5e5e5e5e5e5e5e5e5e5e5e5e5e5e5e5e5e5e5e5e5e64736f6c634300081400330'

// ABI for the deployment
const SPLITTER_ABI = [
  {
    inputs: [],
    stateMutability: 'nonpayable',
    type: 'constructor'
  }
] as const

async function main() {
  // Load private key from env
  const privateKey = process.env.DEPLOYER_KEY
  if (!privateKey) {
    throw new Error('DEPLOYER_KEY not set in environment')
  }

  // Create account from private key
  const account = privateKeyToAccount(`0x${privateKey.replace('0x', '')}`)
  console.log('Deploying from:', account.address)

  // Create clients
  const publicClient = createPublicClient({
    chain: base,
    transport: http(),
  })

  const walletClient = createWalletClient({
    account,
    chain: base,
    transport: http(),
  })

  // Check balance
  const balance = await publicClient.getBalance({ address: account.address })
  console.log('Balance:', balance.toString(), 'wei')

  if (balance < parseEther('0.001')) {
    throw new Error('Insufficient balance for deployment')
  }

  // Deploy contract
  console.log('Deploying FeedMeSplitter to Base...')

  const hash = await walletClient.deployContract({
    abi: SPLITTER_ABI,
    bytecode: SPLITTER_BYTECODE,
  })

  console.log('Transaction hash:', hash)

  // Wait for confirmation
  const receipt = await publicClient.waitForTransactionReceipt({ hash })

  console.log('Contract deployed at:', receipt.contractAddress)
  console.log('Gas used:', receipt.gasUsed.toString())

  return receipt.contractAddress
}

main()
  .then((address) => {
    console.log('\n✅ Deployment successful!')
    console.log('FeedMeSplitter address:', address)
    process.exit(0)
  })
  .catch((error) => {
    console.error('❌ Deployment failed:', error)
    process.exit(1)
  })
